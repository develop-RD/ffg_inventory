{% extends "base.html" %}

{% block title %}{% if item %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %} {{ item_type }}{% endblock %}

{% block content %}
<div class="upload-container">
    <h1>{% if item %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %} {{ item_type }}</h1>
    {% if weapon_class %}<h3>–ö–ª–∞—Å—Å –æ—Ä—É–∂–∏—è: {{ weapon_class }}</h3>{% endif %}
    
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        <!-- –ë–ª–æ–∫ —Ç–µ–∫—É—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
        {% if item and item.image_paths %}
        <div class="form-group">
            <label>–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ—Ç–º–µ—Ç—å—Ç–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è):</label>
            <div class="current-images">
                {% for image_path in item.image_paths.split(',') %}
                <div class="image-item">
                    <img src="{{ url_for('static', filename='uploads/' + image_path) }}" 
                         alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ loop.index }}">
                    <label class="delete-checkbox">
                        <input type="checkbox" name="delete_images" value="{{ image_path }}">
                        <span class="delete-icon">üóëÔ∏è</span>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="form-group">
            <label for="images">
                {% if item %}–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% else %}–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% endif %}
                (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ):
            </label>
            <input type="file" id="images" name="images" accept="image/*" multiple
                   onchange="previewImages(this)">
            
            <div class="images-preview" id="imagesPreview"></div>
            <div class="hint">–ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ({% if item %}–Ω–æ–≤—ã–µ + —Ç–µ–∫—É—â–∏–µ{% endif %})</div>
        </div>

        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="description" name="description" required>{{ item.description if item else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="pros">–ü–ª—é—Å—ã:</label>
            <textarea id="pros" name="pros" required>{{ item.pros if item else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="cons">–ú–∏–Ω—É—Å—ã:</label>
            <textarea id="cons" name="cons" required>{{ item.cons if item else '' }}</textarea>
        </div>
       <!--  –í—ã–±–æ—Ä –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è --> 
        <div class="form-group">
            <label for="model">–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å:</label>
            <select id="model" name="model"> 
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è --</option>
                <option value="Kvetun" {% if item and item.model == 'Kvetun' %}selected{% endif %}>–ö–≤–µ—Ç—É–Ω—å</option>
                <option value="Gold_Sokol" {% if item and item.model == 'Gold_Sokol' %}selected{% endif %}>–ó–æ–ª–æ—Ç–æ–π —Å–æ–∫–æ–ª</option>
                <option value="PikeArmory" {% if item and item.model == 'PikeArmory' %}selected{% endif %}>Pike Armory</option>  
                <option value="PBT" {% if item and item.model == 'PBT' %}selected{% endif %}>PBT</option>  
                <option value="SPES" {% if item and item.model == 'SPES' %}selected{% endif %}>SPES</option>  
                <option value="Fencing Shop" {% if item and item.model == 'Fencing_shop' %}selected{% endif %}>Fencing shop</option>  
                <option value="Pangolins" {% if item and item.model == 'pangolins' %}selected{% endif %}>–ü–∞–Ω–≥–æ–ª–∏–Ω—ã</option>  
                <option value="Foxtail" {% if item and item.model == 'foxtail' %}selected{% endif %}>Fox Tail</option>  
                <option value="Raidu" {% if item and item.model == 'Raidu' %}selected{% endif %}>Raidu</option>  
                <option value="Under_cover" {% if item and item.model == 'under_cover' %}selected{% endif %}>Under Cover</option>  
                <option value="ultima_ratio" {% if item and item.model == 'ultima_ratio' %}selected{% endif %}>Ultima Ratio</option>  
                <option value="raven_blade" {% if item and item.model == 'raven_blade' %}selected{% endif %}>Raven Blade</option>  
            </select>
        </div>

        <div class="form-group">
            <label for="model_site">–°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–µ–ª—å:</label>
            <textarea id="model_site" name="model_site" >{{ item.model_site if item else '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="rating">–†–µ–π—Ç–∏–Ω–≥ (1-5):</label>
            <input type="number" id="rating" name="rating" 
                   value="{{ item.rating if item else 3 }}" 
                   min="1" max="5" required>
        </div>
        
        <input type="hidden" name="weapon_class" value="{{ weapon_class }}">
        
        <div class="form-actions">
            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{{ url_for('view_profile', username=current_user.username, weapon_class=weapon_class) }}" 
               class="btn cancel">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
function previewImages(input) {
    const previewContainer = document.getElementById('imagesPreview');
    previewContainer.innerHTML = '';
    
    const files = Array.from(input.files);
    const maxTotalImages = 5;
    const currentImagesCount = {% if item and item.image_paths %}{{ item.image_paths.split(',')|length }}{% else %}0{% endif %};
    const remainingSlots = maxTotalImages - currentImagesCount;
    
    if (files.length > remainingSlots) {
        alert(`–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${remainingSlots} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–≤—Å–µ–≥–æ –Ω–µ –±–æ–ª–µ–µ 5)`);
        input.value = '';
        return;
    }

    files.slice(0, remainingSlots).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = '–ü—Ä–µ–≤—å—é ' + (index + 1);
            
            previewItem.appendChild(img);
            previewContainer.appendChild(previewItem);
        }
        reader.readAsDataURL(file);
    });
}
</script>

<style>
.upload-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.current-images {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin: 10px 0;
}

.image-item {
    position: relative;
    width: 150px;
    transition: transform 0.2s;
}

.image-item:hover {
    transform: scale(1.05);
}

.image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.delete-checkbox {
    position: absolute;
    top: 5px;
    right: 5px;
    cursor: pointer;
}

.delete-checkbox input {
    display: none;
}

.delete-icon {
    display: inline-block;
    background: rgba(255, 0, 0, 0.7);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-size: 14px;
}

.delete-checkbox input:checked + .delete-icon {
    background: #f44336;
    box-shadow: 0 0 0 2px white;
}

.images-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.preview-item {
    width: 150px;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.hint {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
.form-group {
    margin-bottom: 20px;
}

textarea, input[type="number"], input[type="file"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

textarea {
    height: 100px;
    resize: vertical;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    font-size: 14px;
}

.btn:hover {
    opacity: 0.9;
}

.save-btn {
    background-color: #4CAF50;
    color: white;
}

.delete-btn {
    background-color: #f44336;
    color: white;
}

.cancel {
    background-color: #757575;
    color: white;
}
</style>
{% endblock %}
